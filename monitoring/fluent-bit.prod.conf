# Production Fluent Bit Configuration
[SERVICE]
    Flush         5
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    storage.path  /tmp/fluent-bit-storage/
    storage.sync  normal
    storage.checksum off
    storage.backlog.mem_limit 5M

# Input for Delta Bot application logs
[INPUT]
    Name              tail
    Path              /var/log/delta-bot/*.log
    Tag               production.delta-bot.app
    Parser            delta_bot_json
    Refresh_Interval  5
    storage.type      filesystem
    
# Input for Docker container logs
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Tag               production.delta-bot.container
    Parser            docker
    Refresh_Interval  5

# Filter to add production metadata
[FILTER]
    Name                record_modifier
    Match               production.delta-bot.*
    Record              service delta-bot
    Record              environment production
    Record              version ${VERSION:-latest}
    Record              cluster ${CLUSTER_NAME:-local}
    Record              region ${AWS_REGION:-us-east-1}

# Filter for error detection and alerting
[FILTER]
    Name                grep
    Match               production.delta-bot.app
    Regex               level ERROR|FATAL|PANIC

# Filter to parse and enrich structured logs
[FILTER]
    Name                parser
    Match               production.delta-bot.app
    Key_Name            message
    Parser              delta_bot_structured
    Reserve_Data        On
    Preserve_Key        On

# Output to New Relic Logs with retry logic
[OUTPUT]
    Name                http
    Match               production.delta-bot.*
    Host                log-api.newrelic.com
    Port                443
    URI                 /log/v1
    Format              json
    tls                 on
    tls.verify          on
    Header              Api-Key ${NEW_RELIC_LICENSE_KEY}
    Header              Content-Type application/json
    workers             2
    retry_limit         3

# Backup output to file for debugging
[OUTPUT]
    Name                file
    Match               production.delta-bot.*
    Path                /tmp/fluent-bit-backup/
    File                delta-bot.log
    Format              json_lines